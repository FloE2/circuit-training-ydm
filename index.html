<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Training - WOD</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 15px;
            color: #e0e0e0;
        }

        .setup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .setup-box {
            background: #2d3748;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            color: #e0e0e0;
        }

        .setup-box h2 {
            color: #4299e1;
            margin-bottom: 15px;
            font-size: 1.6em;
            text-align: center;
        }

        .setup-box p {
            color: #a0aec0;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #e0e0e0;
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            font-size: 0.95em;
            border: 2px solid #4a5568;
            border-radius: 8px;
            transition: border-color 0.3s;
            background: #1a202c;
            color: #e0e0e0;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4299e1;
        }

        /* ‚îÄ‚îÄ Team size selector ‚îÄ‚îÄ */
        .team-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .team-btn {
            flex: 1;
            min-width: 52px;
            padding: 10px 6px;
            border: 2px solid #4a5568;
            background: #1a202c;
            color: #a0aec0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s;
            text-align: center;
            line-height: 1.3;
        }

        .team-btn .team-icon { font-size: 1.3em; display: block; margin-bottom: 3px; }
        .team-btn .team-label { display: block; font-size: 0.85em; }

        .team-btn:hover {
            border-color: #9f7aea;
            color: #e0e0e0;
        }

        .team-btn.active-team {
            background: linear-gradient(135deg, #553c9a, #44337a);
            border-color: #9f7aea;
            color: white;
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.4);
        }

        /* Team badge in header */
        .team-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.78em;
            margin-left: 8px;
            background: rgba(159, 122, 234, 0.2);
            color: #9f7aea;
            border: 1px solid #9f7aea;
        }

        /* ‚îÄ‚îÄ Mode selector ‚îÄ‚îÄ */
        .mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #4a5568;
            background: #1a202c;
            color: #a0aec0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s;
            text-align: center;
            line-height: 1.3;
        }

        .mode-btn .mode-icon { font-size: 1.4em; display: block; margin-bottom: 4px; }
        .mode-btn .mode-label { display: block; font-size: 0.95em; }
        .mode-btn .mode-sub { display: block; font-size: 0.7em; opacity: 0.6; margin-top: 2px; }

        .mode-btn:hover:not(.disabled) {
            border-color: #4299e1;
            color: #e0e0e0;
        }

        .mode-btn.active-amrap {
            background: linear-gradient(135deg, #2b6cb0, #2c5282);
            border-color: #4299e1;
            color: white;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
        }

        .mode-btn.active-fortime {
            background: linear-gradient(135deg, #276749, #22543d);
            border-color: #48bb78;
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .mode-btn.disabled {
            opacity: 0.45;
            cursor: not-allowed;
            position: relative;
        }

        /* .mode-btn.disabled::after removed */

        .mode-description {
            font-size: 0.82em;
            color: #a0aec0;
            padding: 8px 12px;
            background: #1a202c;
            border-radius: 8px;
            margin-top: 4px;
            border-left: 3px solid #4299e1;
            transition: border-color 0.3s;
        }

        .mode-description.fortime { border-left-color: #48bb78; }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
        }

        /* ‚îÄ‚îÄ Main container ‚îÄ‚îÄ */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: none;
        }

        .container.visible { display: block; }

        header {
            background: #2d3748;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .header-content { flex: 1; text-align: center; }

        header h1 { color: #4299e1; font-size: 1.8em; margin-bottom: 6px; }

        .wod-info { color: #a0aec0; font-size: 0.95em; }

        /* ‚îÄ‚îÄ Mode badge ‚îÄ‚îÄ */
        .mode-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .mode-badge.amrap {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
            border: 1px solid #4299e1;
        }

        .mode-badge.fortime {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
            border: 1px solid #48bb78;
        }

        /* ‚îÄ‚îÄ Controls / Timer ‚îÄ‚îÄ */
        .controls {
            background: #2d3748;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .timer-display {
            background: linear-gradient(135deg, #2b6cb0 0%, #2c5282 100%);
            color: #fff;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 2.4em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            min-width: 180px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: background 0.3s;
        }

        .timer-display.fortime-running {
            background: linear-gradient(135deg, #276749 0%, #22543d 100%);
        }

        .timer-display.warning {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { background: linear-gradient(135deg, #c53030 0%, #9b2c2c 100%); }
            50% { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        }

        .btn-control {
            padding: 12px 24px;
            font-size: 0.95em;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-start { background: #00C851; color: white; }
        .btn-pause { background: #ff9800; color: white; }
        .btn-reset { background: #ff4444; color: white; }

        .btn-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* ‚îÄ‚îÄ Ateliers grid ‚îÄ‚îÄ */
        .main-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 15px;
        }

        .main-grid.cols-1 { grid-template-columns: 1fr; }
        .main-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .main-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .main-grid.cols-4 { grid-template-columns: repeat(3, 1fr); }
        .main-grid.cols-5 { grid-template-columns: repeat(3, 1fr); }
        .main-grid.cols-6 { grid-template-columns: repeat(3, 1fr); }
        .main-grid.cols-7 { grid-template-columns: repeat(3, 1fr); }
        .main-grid.cols-8 { grid-template-columns: repeat(3, 1fr); }

        .atelier-card {
            background: #2d3748;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .atelier-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .atelier-header {
            background: linear-gradient(135deg, #2b6cb0 0%, #2c5282 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
        }

        .atelier-header.fortime-header {
            background: linear-gradient(135deg, #276749 0%, #22543d 100%);
        }

        .atelier-header h3 { font-size: 1.2em; margin-bottom: 3px; }
        .atelier-duration { font-size: 0.85em; opacity: 0.95; }

        .exercises {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding: 10px;
            background: #1a202c;
            border-radius: 8px;
            min-height: 70px;
        }

        .exercise {
            text-align: center;
            padding: 8px 10px;
            background: #2d3748;
            border-radius: 8px;
            border: 2px solid #4299e1;
        }

        .exercise.fortime-ex { border-color: #48bb78; }

        .exercise-reps {
            font-size: 1.4em;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 3px;
        }

        .exercise-reps.fortime-reps { color: #48bb78; }

        .exercise-name {
            font-size: 0.75em;
            color: #e0e0e0;
            font-weight: 600;
        }

        .plus-sign { font-size: 1.8em; color: #4299e1; font-weight: bold; }
        .plus-sign.fortime-plus { color: #48bb78; }

        /* ‚îÄ‚îÄ Records section ‚îÄ‚îÄ */
        .records-section {
            border-top: 2px dashed #4a5568;
            padding-top: 12px;
        }

        .records-title {
            color: #4299e1;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1em;
            text-align: center;
        }

        .records-title.fortime-title { color: #48bb78; }

        .record-input-form {
            background: #1a202c;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .record-input {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .record-input input {
            padding: 8px;
            border: 2px solid #4a5568;
            border-radius: 6px;
            font-size: 0.85em;
            background: #2d3748;
            color: #e0e0e0;
        }

        .record-input input:focus {
            outline: none;
            border-color: #4299e1;
        }

        /* For Time: time input gets green accent */
        .record-input input.time-input:focus { border-color: #48bb78; }

        .category-selector { display: flex; gap: 6px; margin-bottom: 8px; }

        .category-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #4a5568;
            background: #2d3748;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            transition: all 0.3s;
            color: #e0e0e0;
        }

        .category-btn.active { background: #4299e1; color: white; border-color: #4299e1; }
        .category-btn:hover { border-color: #4299e1; }

        .btn-add {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-size: 0.9em;
        }

        .btn-add:hover { background: #38a169; }

        .records-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .record-item {
            background: #1a202c;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .record-name { font-weight: bold; color: #e0e0e0; font-size: 0.9em; }

        .record-category {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        .category-boys { background: #3182ce; color: white; }
        .category-girls { background: #d53f8c; color: white; }
        .category-mixed { background: #805ad5; color: white; }

        .record-score { color: #4299e1; font-weight: bold; font-size: 1.05em; }
        .record-score.fortime-score { color: #48bb78; }

        .record-actions { display: flex; gap: 4px; margin-left: 8px; }

        .btn-edit-record, .btn-delete-record {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-edit-record { background: #4299e1; color: white; }
        .btn-edit-record:hover { background: #3182ce; }
        .btn-delete-record { background: #e53e3e; color: white; }
        .btn-delete-record:hover { background: #c53030; }

        /* ‚îÄ‚îÄ Rankings ‚îÄ‚îÄ */
        .rankings-section {
            background: #2d3748;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .rankings-title { color: #4299e1; font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 15px; }

        .rankings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }

        .ranking-card { background: #1a202c; border-radius: 10px; padding: 12px; border: 2px solid #4299e1; }
        .ranking-card h4 { color: #4299e1; margin-bottom: 10px; font-size: 1.1em; text-align: center; }

        .ranking-item {
            background: #2d3748;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-item.first { border-left: 4px solid #ffd700; }
        .ranking-item.second { border-left: 4px solid #c0c0c0; }
        .ranking-item.third { border-left: 4px solid #cd7f32; }

        /* ‚îÄ‚îÄ Header buttons ‚îÄ‚îÄ */
        .edit-wod {
            background: #4299e1;
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            border: none;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .edit-wod:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        .btn-clear-records {
            background: #ed8936;
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            border: none;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-clear-records:hover {
            background: #dd6b20;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(237, 137, 54, 0.3);
        }

        /* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
        @media (max-width: 1200px) {
            .main-grid.cols-3 { grid-template-columns: repeat(2, 1fr); }
            .main-grid.cols-4 { grid-template-columns: repeat(2, 1fr); }
            .main-grid.cols-5 { grid-template-columns: repeat(2, 1fr); }
            .main-grid.cols-6 { grid-template-columns: repeat(2, 1fr); }
            .main-grid.cols-7 { grid-template-columns: repeat(2, 1fr); }
            .main-grid.cols-8 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr !important; }
            header h1 { font-size: 1.4em; }
            .timer-display { font-size: 1.8em; padding: 12px 20px; }
            .controls { padding: 10px; }
            header { flex-direction: column; gap: 10px; }
            .edit-wod { width: 100%; }
            .mode-selector { flex-wrap: wrap; }
        }

        .no-records { text-align: center; color: #718096; padding: 15px; font-style: italic; }

        .copyright { text-align: center; color: #718096; padding: 20px; font-size: 0.9em; margin-top: 20px; }

        /* ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ */
        .exercise-tooltip { position: relative; cursor: help; }

        .tooltip-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a202c;
            border: 2px solid #4299e1;
            border-radius: 8px;
            padding: 12px;
            min-width: 250px;
            max-width: 350px;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            margin-bottom: 8px;
        }

        .exercise-tooltip:hover .tooltip-content { display: block; }
        .tooltip-description { color: #e0e0e0; font-size: 0.85em; margin-bottom: 10px; line-height: 1.4; }
        .tooltip-images { display: flex; gap: 8px; justify-content: center; }
        .tooltip-images img { max-width: 120px; max-height: 100px; border-radius: 6px; border: 1px solid #4a5568; }

        /* ‚îÄ‚îÄ Settings ‚îÄ‚îÄ */
        .settings-section { max-height: 60vh; overflow-y: auto; }

        .exercise-list-item {
            background: #1a202c;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-list-item:hover { background: #2d3748; }
        .exercise-info { flex: 1; }
        .exercise-title { color: #4299e1; font-weight: bold; margin-bottom: 4px; }
        .exercise-desc-preview { color: #a0aec0; font-size: 0.85em; font-style: italic; }
        .exercise-actions { display: flex; gap: 8px; }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
        }

        .btn-edit { background: #4299e1; color: white; }
        .btn-delete { background: #e53e3e; color: white; }

        .add-exercise-form { background: #1a202c; padding: 15px; border-radius: 8px; margin-bottom: 20px; }

        .image-upload-preview { display: flex; gap: 10px; margin-top: 10px; }

        .image-preview-item {
            position: relative;
            width: 120px; height: 120px;
            border: 2px dashed #4a5568;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2d3748;
        }

        .image-preview-item img { max-width: 100%; max-height: 100%; border-radius: 6px; }

        .remove-image {
            position: absolute;
            top: -8px; right: -8px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px; height: 24px;
            cursor: pointer;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background: #2d3748;
            color: #e0e0e0;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        textarea:focus { outline: none; border-color: #4299e1; }

        .progress-dot {
            width: 28px; height: 28px;
            border-radius: 50%;
            background: #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85em;
            color: #718096;
            border: 2px solid #4a5568;
            transition: all 0.3s;
        }

        .progress-dot.completed { background: #48bb78; border-color: #48bb78; color: white; }
        .progress-dot.active { background: #4299e1; border-color: #4299e1; color: white; transform: scale(1.2); box-shadow: 0 0 15px rgba(66, 153, 225, 0.6); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .slide-in { animation: slideIn 0.4s ease-out; }

        /* ‚îÄ‚îÄ WOD List ‚îÄ‚îÄ */
        .wod-card {
            background: #1a202c;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #4a5568;
            transition: all 0.3s;
        }

        .wod-card:hover { border-color: #4299e1; transform: translateY(-2px); }
        .wod-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .wod-card-title { color: #4299e1; font-size: 1.3em; font-weight: bold; }
        .wod-card-info { color: #a0aec0; font-size: 0.9em; margin-bottom: 10px; }
        .wod-card-preview { background: #2d3748; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.85em; color: #e0e0e0; }
        .wod-card-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        .btn-wod { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: bold; transition: all 0.3s; }
        .btn-load { background: #48bb78; color: white; }
        .btn-modify { background: #4299e1; color: white; }
        .btn-duplicate { background: #ed8936; color: white; }
        .btn-delete-wod { background: #e53e3e; color: white; }
        .btn-wod:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* WOD mode pill on cards */
        .wod-mode-pill {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .wod-mode-pill.amrap { background: rgba(66,153,225,0.25); color: #4299e1; border: 1px solid #4299e1; }
        .wod-mode-pill.fortime { background: rgba(72,187,120,0.25); color: #48bb78; border: 1px solid #48bb78; }

        /* ‚îÄ‚îÄ Save / Launch ‚îÄ‚îÄ */
        .save-launch-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .save-launch-box { background: #2d3748; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; }
        .save-launch-box h3 { color: #4299e1; margin-bottom: 20px; font-size: 1.5em; }
        .save-launch-box button { width: 100%; margin-bottom: 10px; padding: 15px; font-size: 1.1em; }

        /* ‚îÄ‚îÄ For Time: time input hint ‚îÄ‚îÄ */
        .time-hint {
            font-size: 0.75em;
            color: #718096;
            margin-top: 3px;
            text-align: center;
        }

        /* ‚îÄ‚îÄ DNF badge ‚îÄ‚îÄ */
        .dnf-badge {
            background: #e53e3e;
            color: white;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: bold;
        }

        /* ‚îÄ‚îÄ Auth / Login ‚îÄ‚îÄ */
        .auth-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            padding: 20px;
        }

        .auth-box {
            background: #2d3748;
            padding: 35px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            max-width: 420px;
            width: 100%;
            text-align: center;
        }

        .auth-logo {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .auth-box h2 {
            color: #4299e1;
            margin-bottom: 6px;
            font-size: 1.6em;
        }

        .auth-subtitle {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 25px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 14px;
            background: #1a202c;
            border: 2px solid #4a5568;
            border-radius: 10px;
            color: #e0e0e0;
            font-size: 1em;
            margin-bottom: 12px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #4299e1;
        }

        .btn-login {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, #4299e1, #2b6cb0);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.05em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 4px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.5);
        }

        .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            background: rgba(229, 62, 62, 0.15);
            border: 1px solid #e53e3e;
            color: #fc8181;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.88em;
            margin-bottom: 12px;
            display: none;
        }

        .auth-loading {
            color: #a0aec0;
            font-size: 0.88em;
            margin-top: 10px;
            display: none;
        }

        .auth-user-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(66,153,225,0.1);
            border: 1px solid rgba(66,153,225,0.3);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.82em;
            color: #a0aec0;
        }

        .auth-user-bar span { color: #4299e1; font-weight: bold; }

        .btn-logout {
            background: transparent;
            border: 1px solid #4a5568;
            color: #718096;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            margin-left: auto;
        }

        .btn-logout:hover { border-color: #e53e3e; color: #e53e3e; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EMOM STYLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Mode badge */
        .mode-badge.emom {
            background: rgba(237,137,54,0.2);
            color: #ed8936;
            border: 1px solid #ed8936;
        }

        .mode-btn.active-emom {
            background: linear-gradient(135deg, #c05621, #9c4221);
            border-color: #ed8936;
            color: white;
            box-shadow: 0 4px 15px rgba(237,137,54,0.4);
        }

        .mode-description.emom { border-left-color: #ed8936; }

        .wod-mode-pill.emom { background: rgba(237,137,54,0.25); color: #ed8936; border: 1px solid #ed8936; }

        /* EMOM big panel */
        .emom-panel {
            background: #2d3748;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            border: 2px solid #ed8936;
        }

        .emom-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .emom-stat {
            background: #1a202c;
            border-radius: 10px;
            padding: 10px 18px;
            text-align: center;
            min-width: 100px;
        }

        .emom-stat-value {
            font-size: 2em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #ed8936;
            line-height: 1;
        }

        .emom-stat-label {
            font-size: 0.72em;
            color: #718096;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .emom-minute-countdown {
            font-size: 3.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #fff;
            text-align: center;
            background: linear-gradient(135deg, #c05621, #9c4221);
            padding: 12px 30px;
            border-radius: 14px;
            min-width: 160px;
            box-shadow: 0 4px 20px rgba(237,137,54,0.4);
            transition: background 0.3s;
        }

        .emom-minute-countdown.warning-emom {
            animation: pulseEmom 1s infinite;
        }

        @keyframes pulseEmom {
            0%, 100% { background: linear-gradient(135deg, #c53030, #9b2c2c); }
            50% { background: linear-gradient(135deg, #e53e3e, #c53030); }
        }

        /* Current exercise card */
        .emom-current-card {
            background: linear-gradient(135deg, #c05621 0%, #9c4221 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 12px;
            box-shadow: 0 6px 25px rgba(237,137,54,0.35);
            animation: fadeInSlide 0.4s ease-out;
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(-12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .emom-current-label {
            font-size: 0.78em;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 6px;
        }

        .emom-current-name {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            line-height: 1.15;
        }

        .emom-current-reps {
            font-size: 3em;
            font-weight: bold;
            color: #fef08a;
            line-height: 1;
        }

        .emom-current-reps-label {
            font-size: 0.85em;
            color: rgba(255,255,255,0.75);
            margin-top: 4px;
        }

        /* Next exercise preview */
        .emom-next-card {
            background: #1a202c;
            border: 2px dashed #4a5568;
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .emom-next-label {
            font-size: 0.7em;
            text-transform: uppercase;
            color: #718096;
            letter-spacing: 0.08em;
            white-space: nowrap;
        }

        .emom-next-content {
            flex: 1;
        }

        .emom-next-name {
            color: #e0e0e0;
            font-weight: bold;
            font-size: 0.95em;
        }

        .emom-next-reps {
            color: #ed8936;
            font-size: 0.85em;
        }

        /* Progress dots for EMOM rounds */
        .emom-rounds-row {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 14px;
        }

        .emom-round-dot {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: #1a202c;
            border: 2px solid #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            color: #718096;
            transition: all 0.3s;
        }

        .emom-round-dot.done { background: #48bb78; border-color: #48bb78; color: white; }
        .emom-round-dot.active { background: #ed8936; border-color: #ed8936; color: white; transform: scale(1.2); box-shadow: 0 0 12px rgba(237,137,54,0.6); }

        /* S√©quence list */
        .emom-sequence {
            background: #1a202c;
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            max-height: 220px;
            overflow-y: auto;
        }

        .emom-seq-title {
            color: #ed8936;
            font-weight: bold;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        .emom-seq-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            transition: background 0.3s;
            font-size: 0.88em;
        }

        .emom-seq-item.seq-done { background: rgba(72,187,120,0.12); color: #68d391; }
        .emom-seq-item.seq-active { background: rgba(237,137,54,0.2); color: #fbd38d; font-weight: bold; }
        .emom-seq-item.seq-future { color: #718096; }

        .emom-seq-min {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            min-width: 52px;
            font-size: 0.85em;
        }

        .emom-seq-icon { font-size: 1em; }

        /* Finished overlay */
        .emom-finished {
            background: linear-gradient(135deg, #276749, #22543d);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-bottom: 12px;
            display: none;
        }

        .emom-finished h2 { color: #9ae6b4; font-size: 2em; margin-bottom: 8px; }
        .emom-finished p { color: #68d391; font-size: 1.1em; }

        /* EMOM timer bar */
        .emom-progress-bar-wrap {
            background: #1a202c;
            border-radius: 8px;
            height: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .emom-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ed8936, #fbd38d);
            border-radius: 8px;
            transition: width 1s linear;
        }

        /* Logout prominent button */
        .btn-logout-prominent {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-logout-prominent:hover {
            background: #c53030;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229,62,62,0.4);
        }
    </style>
</head>
<body>

    <!-- ‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <div class="auth-logo">üèãÔ∏è</div>
            <h2>Circuit Training</h2>
            <div class="auth-subtitle">Acc√®s r√©serv√© ‚Äî YDM</div>

            <div class="auth-error" id="authError"></div>

            <input type="email" class="auth-input" id="authEmail" placeholder="Adresse e-mail" autocomplete="email">
            <div style="position:relative; margin-bottom:12px;">
                <input type="password" class="auth-input" id="authPassword"
                    placeholder="Mot de passe" autocomplete="current-password"
                    onkeydown="if(event.key==='Enter') loginUser()"
                    style="margin-bottom:0; padding-right:46px;">
                <button type="button" onclick="togglePasswordVisibility()"
                    style="position:absolute; right:12px; top:50%; transform:translateY(-50%);
                           background:none; border:none; cursor:pointer; font-size:1.2em;
                           line-height:1; padding:0; color:#718096;"
                    title="Afficher/masquer le mot de passe">
                    <span id="eyeIcon">üëÅÔ∏è</span>
                </button>
            </div>

            <button class="btn-login" id="loginBtn" onclick="loginUser()">Se connecter</button>
            <div class="auth-loading" id="authLoading">Connexion en cours‚Ä¶</div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div class="setup-overlay" id="welcomeScreen">
        <div class="setup-box" style="max-width: 500px;">
            <h2>Circuit Training</h2>
            <p>Gestion de vos s√©ances de WOD</p>
            <button class="btn btn-primary" onclick="createNewWOD()" style="margin-bottom: 15px; padding: 20px; font-size: 1.2em;">
                Nouveau WOD
            </button>
            <button class="btn btn-primary" onclick="showMyWODs()" style="background: #48bb78; padding: 20px; font-size: 1.2em; margin-bottom: 15px;">
                Mes WODs sauvegard√©s
            </button>
            <button class="btn btn-primary" onclick="openSettingsFromWelcome()" style="background: #ed8936; padding: 20px; font-size: 1.2em;">
                G√©rer les exercices
            </button>
        </div>
    </div>

    <!-- My WODs List -->
    <div class="setup-overlay" id="myWODsScreen" style="display: none;">
        <div class="setup-box" style="max-width: 900px;">
            <h2>Mes WODs sauvegard√©s</h2>
            <p>Chargez, modifiez ou supprimez vos WODs</p>
            <div id="wodsList" style="margin: 20px 0; max-height: 60vh; overflow-y: auto;"></div>
            <button class="btn" onclick="backToWelcome()" style="background: #718096; color: white;">Retour</button>
        </div>
    </div>

    <!-- Setup WOD Configuration -->
    <div class="setup-overlay" id="setupOverlay" style="display: none;">
        <div class="setup-box">
            <h2>Configuration du WOD</h2>
            <p>Param√©trez votre s√©ance de circuit training</p>

            <!-- MODE SELECTOR -->
            <div class="form-group">
                <label>Mode d'entra√Ænement</label>
                <div class="mode-selector">
                    <button type="button" class="mode-btn active-amrap" id="modeBtn_amrap" onclick="selectWodMode('amrap')">
                        <span class="mode-icon">‚è≥</span>
                        <span class="mode-label">AMRAP</span>
                        <span class="mode-sub">Max de reps</span>
                    </button>
                    <button type="button" class="mode-btn" id="modeBtn_fortime" onclick="selectWodMode('fortime')">
                        <span class="mode-icon">‚ö°</span>
                        <span class="mode-label">For Time</span>
                        <span class="mode-sub">Le plus vite</span>
                    </button>
                    <button type="button" class="mode-btn" id="modeBtn_emom" onclick="selectWodMode('emom')">
                        <span class="mode-icon">üîÑ</span>
                        <span class="mode-label">EMOM</span>
                        <span class="mode-sub">Chaque minute</span>
                    </button>
                </div>
                <div class="mode-description" id="modeDesc">
                    <strong>AMRAP</strong> ‚Äî En un temps limit√©, r√©aliser un <em>maximum de r√©p√©titions</em>. Le score est le nombre de reps total.
                </div>
            </div>

            <div class="form-group">
                <label>Nom du WOD</label>
                <input type="text" id="wodName" placeholder="Ex: WOD Cardio 5√®me">
            </div>

            <div class="form-group">
                <label>Nombre d'ateliers (1-8)</label>
                <input type="number" id="numAteliers" min="1" max="8" value="3">
            </div>

            <!-- Duration / TimeCap (hidden for EMOM) -->
            <div class="form-group" id="durationGroup">
                <label id="durationLabel">Dur√©e AMRAP (minutes)</label>
                <input type="number" id="duration" min="2" max="30" value="5">
            </div>

            <!-- EMOM : nombre de tours (hidden for AMRAP/ForTime) -->
            <div class="form-group" id="toursGroup" style="display:none;">
                <label>Nombre de tours (cycles)</label>
                <input type="number" id="numTours" min="1" max="20" value="3">
                <small style="color:#718096; margin-top:4px; display:block;">
                    Ex : 3 tours √ó 4 exercices = 12 minutes au total
                </small>
            </div>

            <!-- TEAM SIZE -->
            <div class="form-group">
                <label>Format de travail</label>
                <div class="team-selector">
                    <button type="button" class="team-btn active-team" id="teamBtn_1" onclick="selectTeamSize(1)">
                        <span class="team-icon">üßç</span>
                        <span class="team-label">Indiv</span>
                    </button>
                    <button type="button" class="team-btn" id="teamBtn_2" onclick="selectTeamSize(2)">
                        <span class="team-icon">üë•</span>
                        <span class="team-label">Duo</span>
                    </button>
                    <button type="button" class="team-btn" id="teamBtn_3" onclick="selectTeamSize(3)">
                        <span class="team-icon">üë•</span>
                        <span class="team-label">Trio</span>
                    </button>
                    <button type="button" class="team-btn" id="teamBtn_4" onclick="selectTeamSize(4)">
                        <span class="team-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                        <span class="team-label">4 √©l√®ves</span>
                    </button>
                    <button type="button" class="team-btn" id="teamBtn_5" onclick="selectTeamSize(5)">
                        <span class="team-icon">üèÖ</span>
                        <span class="team-label">5 √©l√®ves</span>
                    </button>
                </div>
            </div>

            <button class="btn btn-primary" onclick="setupAteliers()">
                Configurer les ateliers ‚Üí
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container" id="mainContainer">
        <header>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="edit-wod" id="editButton" onclick="resetApp()" style="display: none;">Modifier</button>
                <button class="edit-wod" id="settingsButton" onclick="openSettings()" style="display: none;">Param√®tres</button>
                <button class="btn-clear-records" id="clearRecordsButton" onclick="clearAllRecords()" style="display: none;">Effacer les records</button>
                <button class="edit-wod" id="quitButton" onclick="quitWOD()" style="display: none; background: #e53e3e;">Quitter</button>
            </div>
            <div class="header-content">
                <div class="auth-user-bar" id="userBar" style="display:none;justify-content:center;margin-bottom:8px;">
                    <span>üîê</span>
                    <span id="userEmail"></span>
                    <button class="btn-logout-prominent" onclick="logoutUser()">üö™ Se d√©connecter</button>
                </div>
                <h1>
                    <span id="headerWodName">Circuit Training</span>
                    <span class="mode-badge amrap" id="modeBadge">AMRAP</span>
                    <span class="team-badge" id="teamBadge">üßç Indiv</span>
                </h1>
                <div class="wod-info" id="wodInfo"></div>
            </div>
            <div style="width: 100px;"></div>
        </header>

        <div class="controls">
            <div class="timer-display" id="timerDisplay">00:00</div>
            <button class="btn-control btn-start" onclick="startTimer()">D√©marrer</button>
            <button class="btn-control btn-pause" onclick="pauseTimer()">Pause</button>
            <button class="btn-control btn-reset" onclick="resetTimer()">R√©initialiser</button>
        </div>

        <!-- EMOM Panel -->
        <div class="emom-panel" id="emomPanel" style="display:none;">
            <!-- Stats row -->
            <div class="emom-header-row">
                <div class="emom-stat">
                    <div class="emom-stat-value" id="emomMinuteNum">1</div>
                    <div class="emom-stat-label">Minute</div>
                </div>
                <div class="emom-minute-countdown" id="emomCountdown">60</div>
                <div class="emom-stat">
                    <div class="emom-stat-value" id="emomTourNum">1</div>
                    <div class="emom-stat-label">Tour</div>
                </div>
            </div>

            <!-- Progress bar -->
            <div class="emom-progress-bar-wrap">
                <div class="emom-progress-bar" id="emomProgressBar" style="width:100%;"></div>
            </div>

            <!-- Current exercise -->
            <div class="emom-current-card" id="emomCurrentCard" style="margin-top:14px;">
                <div class="emom-current-label">Exercice en cours</div>
                <div class="emom-current-name" id="emomCurrentName">‚Äî</div>
                <div class="emom-current-reps" id="emomCurrentReps">‚Äî</div>
                <div class="emom-current-reps-label" id="emomCurrentRepsLabel">r√©p√©titions</div>
            </div>

            <!-- Next exercise -->
            <div class="emom-next-card" id="emomNextCard">
                <div class="emom-next-label">‚è≠ Suivant</div>
                <div class="emom-next-content">
                    <div class="emom-next-name" id="emomNextName">‚Äî</div>
                    <div class="emom-next-reps" id="emomNextReps"></div>
                </div>
            </div>

            <!-- Rounds dots -->
            <div class="emom-rounds-row" id="emomRoundsRow"></div>

            <!-- Sequence list -->
            <div class="emom-sequence">
                <div class="emom-seq-title">üìã Programme complet</div>
                <div id="emomSequenceList"></div>
            </div>
        </div>

        <!-- EMOM Finished -->
        <div class="emom-finished" id="emomFinished">
            <h2>üéâ WOD termin√© !</h2>
            <p id="emomFinishedMsg"></p>
        </div>

        <!-- Global Rankings -->
        <div class="rankings-section" id="globalRankings" style="display: none;">
            <h3 class="rankings-title">Classement G√©n√©ral du WOD</h3>
            <div class="rankings-grid">
                <div class="ranking-card">
                    <h4 id="globalRankTitle">Top 3 Global</h4>
                    <div id="globalTop3"></div>
                </div>
            </div>
        </div>

        <!-- Ateliers Grid -->
        <div class="main-grid" id="ateliersGrid"></div>

        <div class="copyright">¬© EUDE Florian - YDM</div>
    </div>

    <!-- Atelier Configuration Modal -->
    <div class="setup-overlay" id="atelierSetupOverlay" style="display: none;">
        <div class="setup-box">
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 10px;" id="atelierProgress"></div>
            </div>
            <h2>Configuration Atelier <span id="currentAtelierNum"></span></h2>

            <div class="form-group">
                <label>Nombre d'exercices (1-5)</label>
                <input type="number" id="numExercises" min="1" max="5" value="2">
            </div>

            <div id="exercisesConfig"></div>

            <button class="btn btn-primary" onclick="saveAtelierConfig()">Valider cet atelier ‚úì</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="setup-overlay" id="settingsOverlay" style="display: none;">
        <div class="setup-box" style="max-width: 800px;">
            <h2>Gestion des Exercices</h2>
            <p>Ajoutez, modifiez ou supprimez des exercices</p>

            <div class="add-exercise-form">
                <h3 style="color: #4299e1; margin-bottom: 15px;" id="formTitle">Ajouter un nouvel exercice</h3>
                <div class="form-group">
                    <label>Nom de l'exercice</label>
                    <input type="text" id="exerciseName" placeholder="Ex: Tractions, Pompes diamant...">
                    <small style="color: #718096;">Cr√©ez un nouvel exercice ou s√©lectionnez-en un dans la liste ci-dessous</small>
                </div>
                <div class="form-group">
                    <label>Description courte</label>
                    <textarea id="exerciseDescription" placeholder="Ex: Squat avec saut √† l'extension" maxlength="150"></textarea>
                    <small style="color: #718096;">Maximum 150 caract√®res</small>
                </div>
                <div class="form-group">
                    <label>Images (max 2)</label>
                    <input type="file" id="imageInput1" accept="image/*" onchange="previewImage(0)" style="margin-bottom: 8px;">
                    <input type="file" id="imageInput2" accept="image/*" onchange="previewImage(1)">
                    <div class="image-upload-preview" id="imagePreviewContainer"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveExercise()" style="flex: 1;">
                        <span id="saveButtonText">Cr√©er l'exercice</span>
                    </button>
                    <button class="btn" onclick="cancelEditExercise()" id="cancelEditBtn" style="display: none; background: #718096; color: white;">Annuler</button>
                </div>
            </div>

            <div class="settings-section">
                <h3 style="color: #4299e1; margin-bottom: 15px;">Liste des exercices</h3>
                <div id="exerciseListContainer"></div>
            </div>

            <button class="btn btn-primary" onclick="closeSettings()" style="margin-top: 20px;">Fermer</button>
        </div>
    </div>

    <!-- Save or Launch Screen -->
    <div class="save-launch-screen" id="saveLaunchScreen">
        <div class="save-launch-box">
            <h3>WOD configur√© ‚úì</h3>
            <p style="color: #a0aec0; margin-bottom: 25px;">Que souhaitez-vous faire ?</p>
            <button class="btn btn-primary" onclick="launchNow()" style="background: #48bb78;">Lancer maintenant</button>
            <button class="btn btn-primary" onclick="saveForLater()">Sauvegarder pour plus tard</button>
            <button class="btn" onclick="backToConfig()" style="background: #718096; color: white;">Retour √† la config</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  EXERCISES LIST
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const EXERCISES = [
        'Air Squat','Box Jump Over','Burpees','Burpees Pogo','Butterfly Sit Ups',
        'Farmer Carry','Inchworm','Jumping Jack','KB High Pull','KB Swing US',
        'Knee to Jump','Lunge Jumps','MB Russian Twist','Push Up','Side Shuffle',
        'Single Under','Squat Jumps','Up & Down Planks','Wall Ball'
    ].sort();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FIREBASE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const firebaseConfig = {
        apiKey: "AIzaSyBc0dO60IWnrpgUJ80DPR2foE7_4VXwQx8",
        authDomain: "circuit-training-college-ydm.firebaseapp.com",
        databaseURL: "https://circuit-training-college-ydm-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "circuit-training-college-ydm",
        storageBucket: "circuit-training-college-ydm.firebasestorage.app",
        messagingSenderId: "795066582832",
        appId: "1:795066582832:web:90897fb3c24b9b2dae2af5"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ALLOWED_EMAILS = ['florianeude@gmail.com', 'cosperecemeric@gmail.com'];

    function showAuthError(msg) {
        const el = document.getElementById('authError');
        el.textContent = msg;
        el.style.display = 'block';
    }

    function hideAuthError() {
        const el = document.getElementById('authError');
        if (el) el.style.display = 'none';
    }

    function togglePasswordVisibility() {
        const input = document.getElementById('authPassword');
        const icon = document.getElementById('eyeIcon');
        if (input.type === 'password') {
            input.type = 'text';
            icon.textContent = 'üôà';
        } else {
            input.type = 'password';
            icon.textContent = 'üëÅÔ∏è';
        }
    }

    async function loginUser() {
        const email = document.getElementById('authEmail').value.trim().toLowerCase();
        const password = document.getElementById('authPassword').value;
        hideAuthError();

        if (!email || !password) { showAuthError('Veuillez remplir tous les champs.'); return; }
        if (!ALLOWED_EMAILS.includes(email)) { showAuthError('Acc√®s non autoris√© pour cet email.'); return; }

        const btn = document.getElementById('loginBtn');
        const loading = document.getElementById('authLoading');
        btn.disabled = true;
        loading.style.display = 'block';

        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            loading.style.display = 'none';
            btn.disabled = false;
            const msgs = {
                'auth/user-not-found': 'Aucun compte trouv√© pour cet email.',
                'auth/wrong-password': 'Mot de passe incorrect.',
                'auth/invalid-email': 'Adresse email invalide.',
                'auth/too-many-requests': 'Trop de tentatives. R√©essayez plus tard.',
                'auth/invalid-credential': 'Email ou mot de passe incorrect.'
            };
            showAuthError(msgs[error.code] || 'Erreur : ' + error.message);
        }
    }

    async function logoutUser() {
        if (confirm('Se d√©connecter ?')) await auth.signOut();
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'flex';
            const userBar = document.getElementById('userBar');
            if (userBar) { userBar.style.display = 'flex'; }
            const userEmail = document.getElementById('userEmail');
            if (userEmail) userEmail.textContent = user.email;
        } else {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('myWODsScreen').style.display = 'none';
            document.getElementById('setupOverlay').style.display = 'none';
            document.getElementById('mainContainer').classList.remove('visible');
            const userBar = document.getElementById('userBar');
            if (userBar) userBar.style.display = 'none';
            const btn = document.getElementById('loginBtn');
            if (btn) btn.disabled = false;
            const loading = document.getElementById('authLoading');
            if (loading) loading.style.display = 'none';
            hideAuthError();
        }
    });

    let exerciseData = {};
    let currentEditingExercise = null;
    let imagePreviews = [null, null];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let wodConfig = {
        name: '',
        mode: 'amrap',   // 'amrap' | 'fortime' | 'emom'
        teamSize: 1,     // 1 = indiv, 2-5 = groupe
        numAteliers: 3,
        duration: 5,     // AMRAP: countdown minutes | ForTime: time cap minutes
        numTours: 3,     // EMOM: number of rounds
        ateliers: []
    };

    let selectedWodMode = 'amrap'; // local UI state for setup form
    let selectedTeamSize = 1; // 1-5
    let currentWODId = null;
    let savedWODs = {};
    let currentAtelierIndex = 0;
    let timerInterval = null;
    let timeLeft = 0;     // AMRAP: seconds remaining
    let timeElapsed = 0;  // For Time: seconds elapsed
    let isRunning = false;
    let selectedCategories = {};
    let audioContext = null;

    const SESSION_KEY = 'wod_session_data';
    const SESSION_TIMESTAMP_KEY = 'wod_session_timestamp';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MODE SELECTION (setup form)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function selectWodMode(mode) {
        selectedWodMode = mode;

        ['amrap','fortime','emom'].forEach(m => {
            const btn = document.getElementById(`modeBtn_${m}`);
            if (btn) btn.className = 'mode-btn';
        });
        const activeBtn = document.getElementById(`modeBtn_${mode}`);
        if (activeBtn) activeBtn.className = `mode-btn active-${mode}`;

        const desc = document.getElementById('modeDesc');
        const durationLabel = document.getElementById('durationLabel');
        const durationGroup = document.getElementById('durationGroup');
        const toursGroup = document.getElementById('toursGroup');

        if (mode === 'amrap') {
            desc.className = 'mode-description';
            desc.innerHTML = '<strong>AMRAP</strong> ‚Äî En un temps limit√©, r√©aliser un <em>maximum de r√©p√©titions</em>. Le score est le nombre de reps total.';
            durationLabel.textContent = 'Dur√©e AMRAP (minutes)';
            durationGroup.style.display = 'block';
            toursGroup.style.display = 'none';
        } else if (mode === 'fortime') {
            desc.className = 'mode-description fortime';
            desc.innerHTML = '<strong>For Time</strong> ‚Äî R√©aliser un nombre fixe de r√©p√©titions <em>le plus rapidement possible</em>. Le score est le temps r√©alis√© (+ bas = meilleur).';
            durationLabel.textContent = 'Time cap (limite de temps en minutes)';
            durationGroup.style.display = 'block';
            toursGroup.style.display = 'none';
        } else if (mode === 'emom') {
            desc.className = 'mode-description emom';
            desc.innerHTML = "<strong>EMOM</strong> ‚Äî <em>Every Minute On the Minute</em> : au d√©but de chaque minute, r√©aliser les reps de l'exercice. Le reste de la minute = r√©cup√©ration. On change d'exercice √† chaque minute.";
            durationGroup.style.display = 'none';
            toursGroup.style.display = 'block';
        }
    }

    function selectTeamSize(size) {
        selectedTeamSize = size;
        for (let i = 1; i <= 5; i++) {
            const btn = document.getElementById(`teamBtn_${i}`);
            if (btn) btn.className = 'team-btn' + (i === size ? ' active-team' : '');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUDIO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function playBeep() {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain); gain.connect(audioContext.destination);
                osc.frequency.value = 800; osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.5);
            }, i * 400);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LOCAL STORAGE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function saveSessionData() {
        try {
            const sessionData = {
                wodName: wodConfig.name,
                records: wodConfig.ateliers.map(a => a.records || [])
            };
            localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
            localStorage.setItem(SESSION_TIMESTAMP_KEY, Date.now().toString());
        } catch(e) { console.error('localStorage save error:', e); }
    }

    function loadSessionData() {
        try {
            const saved = localStorage.getItem(SESSION_KEY);
            if (!saved) return null;
            const data = JSON.parse(saved);
            if (data.wodName === wodConfig.name) return data.records;
            return null;
        } catch(e) { return null; }
    }

    function clearAllRecords() {
        if (!confirm('Effacer tous les records de la s√©ance en cours ?\n\nCette action est irr√©versible.')) return;
        localStorage.removeItem(SESSION_KEY);
        localStorage.removeItem(SESSION_TIMESTAMP_KEY);
        wodConfig.ateliers.forEach(a => { a.records = []; });
        for (let i = 0; i < wodConfig.numAteliers; i++) updateRecordsList(i);
        updateGlobalRankings();
        alert('Tous les records ont √©t√© effac√©s');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SETUP FLOW
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function setupAteliers() {
        const name = document.getElementById('wodName').value.trim();
        const num = parseInt(document.getElementById('numAteliers').value);

        if (!name) { alert('Donnez un nom √† votre WOD'); return; }
        if (num < 1 || num > 8) { alert("Le nombre d'ateliers doit √™tre entre 1 et 8"); return; }

        let duration = 5, numTours = 3;

        if (selectedWodMode === 'emom') {
            numTours = parseInt(document.getElementById('numTours').value);
            if (isNaN(numTours) || numTours < 1 || numTours > 20) { alert('Le nombre de tours doit √™tre entre 1 et 20'); return; }
        } else {
            duration = parseInt(document.getElementById('duration').value);
            if (isNaN(duration) || duration < 2 || duration > 30) { alert('La dur√©e doit √™tre entre 2 et 30 minutes'); return; }
        }

        wodConfig.name = name;
        wodConfig.mode = selectedWodMode;
        wodConfig.teamSize = selectedTeamSize;
        wodConfig.numAteliers = num;
        wodConfig.duration = duration;
        wodConfig.numTours = numTours;

        if (wodConfig.ateliers.length > num) wodConfig.ateliers = wodConfig.ateliers.slice(0, num);
        currentAtelierIndex = 0;

        document.getElementById('setupOverlay').style.display = 'none';
        showAtelierConfig();
    }

    function showAtelierConfig() {
        if (currentAtelierIndex >= wodConfig.numAteliers) { finishSetup(); return; }

        document.getElementById('atelierSetupOverlay').style.display = 'flex';
        document.getElementById('currentAtelierNum').textContent = currentAtelierIndex + 1;
        updateProgressDots();

        const box = document.querySelector('#atelierSetupOverlay .setup-box');
        box.classList.remove('slide-in'); void box.offsetWidth; box.classList.add('slide-in');

        const existing = wodConfig.ateliers[currentAtelierIndex];
        const numEx = existing ? existing.exercises.length : 2;
        document.getElementById('numExercises').value = numEx;
        generateExerciseInputs(numEx);

        if (existing) {
            existing.exercises.forEach((ex, i) => {
                document.getElementById(`exercise_${i}`).value = ex.name;
                document.getElementById(`reps_${i}`).value = ex.reps;
            });
        }

        document.getElementById('numExercises').onchange = function() {
            const n = parseInt(this.value);
            if (n >= 1 && n <= 5) generateExerciseInputs(n);
        };
    }

    function updateProgressDots() {
        const pc = document.getElementById('atelierProgress');
        pc.innerHTML = '';
        for (let i = 0; i < wodConfig.numAteliers; i++) {
            const dot = document.createElement('div');
            dot.className = 'progress-dot';
            dot.textContent = i + 1;
            if (i < currentAtelierIndex) dot.classList.add('completed');
            else if (i === currentAtelierIndex) dot.classList.add('active');
            pc.appendChild(dot);
        }
    }

    function generateExerciseInputs(num) {
        const container = document.getElementById('exercisesConfig');
        container.innerHTML = '';
        const modeLabel = wodConfig.mode === 'fortime' ? 'R√©p√©titions √† r√©aliser' : (wodConfig.mode === 'emom' ? 'R√©p√©titions √† faire dans la minute' : 'R√©p√©titions');
        for (let i = 0; i < num; i++) {
            const group = document.createElement('div');
            group.className = 'form-group';
            group.innerHTML = `
                <label>Exercice ${i + 1}</label>
                <select id="exercise_${i}" style="margin-bottom: 6px;">
                    ${EXERCISES.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                </select>
                <input type="number" id="reps_${i}" min="1" max="200" value="10" placeholder="${modeLabel}">
            `;
            container.appendChild(group);
        }
    }

    function saveAtelierConfig() {
        const numEx = parseInt(document.getElementById('numExercises').value);
        const exercises = [];
        for (let i = 0; i < numEx; i++) {
            const name = document.getElementById(`exercise_${i}`).value;
            const reps = parseInt(document.getElementById(`reps_${i}`).value);
            if (reps < 1 || reps > 200) { alert('Les r√©p√©titions doivent √™tre entre 1 et 200'); return; }
            exercises.push({ name, reps });
        }
        if (wodConfig.ateliers[currentAtelierIndex]) {
            wodConfig.ateliers[currentAtelierIndex] = {
                exercises,
                records: wodConfig.ateliers[currentAtelierIndex].records || []
            };
        } else {
            wodConfig.ateliers.push({ exercises, records: [] });
        }
        currentAtelierIndex++;
        showAtelierConfig();
    }

    function finishSetup() {
        document.getElementById('atelierSetupOverlay').style.display = 'none';
        if (wodConfig.ateliers.length < wodConfig.numAteliers) {
            alert('Erreur : Tous les ateliers ne sont pas configur√©s.');
            currentAtelierIndex = 0; showAtelierConfig(); return;
        }
        if (currentWODId && savedWODs[currentWODId]) {
            showMainContainer();
        } else {
            document.getElementById('saveLaunchScreen').style.display = 'flex';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MAIN CONTAINER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showMainContainer() {
        if (!wodConfig.ateliers || wodConfig.ateliers.length === 0) {
            alert('Erreur : WOD invalide.'); location.reload(); return;
        }
        const saved = loadSessionData();
        if (saved && saved.length === wodConfig.ateliers.length) {
            wodConfig.ateliers.forEach((a, i) => { a.records = saved[i] || []; });
        }

        document.getElementById('mainContainer').classList.add('visible');
        document.getElementById('editButton').style.display = 'block';
        document.getElementById('settingsButton').style.display = 'block';
        document.getElementById('clearRecordsButton').style.display = wodConfig.mode === 'emom' ? 'none' : 'block';
        document.getElementById('quitButton').style.display = 'block';

        // Hide the generic timer bar for EMOM (it has its own countdown)
        document.querySelector('.controls').style.display = wodConfig.mode === 'emom' ? 'none' : 'flex';

        renderWOD();
        if (wodConfig.mode !== 'emom') {
            resetTimer();
            updateGlobalRankings();
        }
    }

    function quitWOD() {
        if (confirm('Quitter le WOD ?\n\nLes records resteront sauvegard√©s pour cette s√©ance.')) {
            pauseEmom();
            location.reload();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RENDER WOD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderWOD() {
        const isForTime = wodConfig.mode === 'fortime';
        const isEmom = wodConfig.mode === 'emom';

        // Mode Badge
        const badge = document.getElementById('modeBadge');
        const teamBadge = document.getElementById('teamBadge');
        if (isForTime) {
            badge.className = 'mode-badge fortime'; badge.textContent = '‚ö° For Time';
        } else if (isEmom) {
            badge.className = 'mode-badge emom'; badge.textContent = 'üîÑ EMOM';
        } else {
            badge.className = 'mode-badge amrap'; badge.textContent = '‚è≥ AMRAP';
        }

        // Team badge
        const teamSize = wodConfig.teamSize || 1;
        const teamLabels = { 1:'üßç Indiv', 2:'üë• Duo', 3:'üë• Trio', 4:'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 4 √©l√®ves', 5:'üèÖ 5 √©l√®ves' };
        teamBadge.textContent = teamLabels[teamSize] || 'üßç Indiv';

        // Info text
        let infoSuffix;
        if (isEmom) {
            const totalEx = wodConfig.ateliers.reduce((s, a) => s + a.exercises.length, 0);
            const totalMin = totalEx * (wodConfig.numTours || 3);
            infoSuffix = `${wodConfig.numTours} tours √ó ${totalEx} exercices = ${totalMin} minutes ‚Äî EMOM`;
        } else if (isForTime) {
            infoSuffix = `Time cap : ${wodConfig.duration} min ‚Äî Finir le plus vite possible`;
        } else {
            infoSuffix = `${wodConfig.duration} min ‚Äî AMRAP (max de r√©p√©titions)`;
        }

        const teamSizeLabel = teamSize === 1 ? 'Individuel' : `√âquipes de ${teamSize}`;
        document.getElementById('wodInfo').textContent =
            `${wodConfig.numAteliers} atelier${wodConfig.numAteliers > 1 ? 's' : ''} √ó ${infoSuffix} ‚Äî ${teamSizeLabel}`;

        // Show/hide EMOM panel vs ateliers grid
        document.getElementById('emomPanel').style.display = isEmom ? 'block' : 'none';
        document.getElementById('emomFinished').style.display = 'none';
        document.getElementById('globalRankings').style.display = (isEmom) ? 'none' : 'none'; // rankings handled elsewhere
        document.getElementById('clearRecordsButton').style.display = isEmom ? 'none' : 'block';

        const grid = document.getElementById('ateliersGrid');
        grid.className = `main-grid cols-${wodConfig.numAteliers}`;
        grid.innerHTML = '';

        if (isEmom) {
            renderEmomAtelierCards();
            initEmomDisplay();
            return;
        }

        // AMRAP / ForTime ateliers
        wodConfig.ateliers.forEach((atelier, index) => {
            selectedCategories[index] = 'mixed';
            const card = document.createElement('div');
            card.className = 'atelier-card';

            const exercisesHTML = atelier.exercises.map((ex, i) => {
                const exData = exerciseData[ex.name] || { description: '', images: [] };
                const hasTooltip = exData.description || (exData.images && exData.images.length > 0);
                const tooltipHTML = hasTooltip ? `
                    <div class="tooltip-content">
                        ${exData.description ? `<div class="tooltip-description">${exData.description}</div>` : ''}
                        ${exData.images && exData.images.length > 0 ? `
                            <div class="tooltip-images">
                                ${exData.images.map(img => `<img src="${img}" alt="${ex.name}">`).join('')}
                            </div>` : ''}
                    </div>` : '';
                return `
                    <div class="exercise ${hasTooltip ? 'exercise-tooltip' : ''} ${isForTime ? 'fortime-ex' : ''}">
                        <div class="exercise-reps ${isForTime ? 'fortime-reps' : ''}">${ex.reps}</div>
                        <div class="exercise-name">${ex.name}</div>
                        ${tooltipHTML}
                    </div>
                    ${i < atelier.exercises.length - 1 ? `<div class="plus-sign ${isForTime ? 'fortime-plus' : ''}">+</div>` : ''}
                `;
            }).join('');

            const scoreInputClass = isForTime ? 'class="time-input"' : '';
            const scoreInputType = isForTime ? 'text' : 'number';
            const scorePlaceholder = isForTime ? 'MM:SS' : 'R√©p√©titions';
            const timeHint = isForTime ? `<div class="time-hint">Format MM:SS (ex: 3:42) ou laisser vide si DNF</div>` : '';
            const titleColor = isForTime ? 'fortime-title' : '';
            const headerClass = isForTime ? 'atelier-header fortime-header' : 'atelier-header';
            const headerSub = isForTime
                ? `${atelier.exercises.reduce((s, e) => s + e.reps, 0)} reps au total ‚Äî For Time`
                : `${wodConfig.duration}' ‚Äî AMRAP`;

            card.innerHTML = `
                <div class="${headerClass}">
                    <h3>Atelier ${index + 1}</h3>
                    <div class="atelier-duration">${headerSub}</div>
                </div>
                <div class="exercises">${exercisesHTML}</div>
                <div class="records-section">
                    <div class="records-title ${titleColor}">Ajouter un r√©sultat</div>
                    <div class="record-input-form">
                        <div class="category-selector">
                            <button class="category-btn active" onclick="selectCategory(${index}, 'mixed')">Mixte</button>
                            <button class="category-btn" onclick="selectCategory(${index}, 'boys')">Gar√ßons</button>
                            <button class="category-btn" onclick="selectCategory(${index}, 'girls')">Filles</button>
                        </div>
                        <div class="record-input">
                            <input type="text" placeholder="Pr√©nom(s) - ex: Tom & L√©a" id="name_${index}">
                            <input type="${scoreInputType}" ${scoreInputClass} placeholder="${scorePlaceholder}" id="score_${index}" ${scoreInputType === 'number' ? 'min="0"' : ''}>
                        </div>
                        ${timeHint}
                        ${isForTime ? `
                        <div style="margin-bottom:8px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.85em;color:#a0aec0;">
                                <input type="checkbox" id="dnf_${index}"> DNF (Did Not Finish)
                            </label>
                        </div>` : ''}
                        <button class="btn-add" onclick="addRecord(${index})">Ajouter le r√©sultat</button>
                    </div>
                    <div class="records-title ${titleColor}" style="margin-top:15px;">Top 3</div>
                    <div class="records-list" id="records_${index}">
                        <div class="no-records">Aucun r√©sultat pour le moment</div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            updateRecordsList(index);
        });
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CATEGORY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function selectCategory(atelierIndex, category) {
        selectedCategories[atelierIndex] = category;
        const card = document.querySelector(`#records_${atelierIndex}`).closest('.atelier-card');
        const buttons = card.querySelectorAll('.category-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        const map = { 'mixed': 0, 'boys': 1, 'girls': 2 };
        buttons[map[category]].classList.add('active');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RECORDS ‚Äî ADD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function parseTimeInput(str) {
        // Returns seconds. Accepts "3:42" or "3m42" or "222" (raw seconds)
        if (!str) return null;
        str = str.trim().replace(',', ':');
        const colonMatch = str.match(/^(\d+):([0-5]?\d)$/);
        if (colonMatch) return parseInt(colonMatch[1]) * 60 + parseInt(colonMatch[2]);
        const numOnly = parseInt(str);
        if (!isNaN(numOnly) && numOnly > 0) return numOnly;
        return null;
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function addRecord(atelierIndex) {
        const name = document.getElementById(`name_${atelierIndex}`).value.trim();
        const category = selectedCategories[atelierIndex] || 'mixed';
        const isForTime = wodConfig.mode === 'fortime';

        if (!name) { alert('Entrez un nom d\'√©quipe'); return; }

        let score, isDNF = false;

        if (isForTime) {
            const dnfCheckbox = document.getElementById(`dnf_${atelierIndex}`);
            isDNF = dnfCheckbox ? dnfCheckbox.checked : false;

            if (isDNF) {
                score = Infinity; // DNF goes to bottom
            } else {
                const raw = document.getElementById(`score_${atelierIndex}`).value;
                score = parseTimeInput(raw);
                if (score === null) { alert('Entrez un temps valide au format MM:SS (ex: 3:42)'); return; }
            }
        } else {
            score = parseInt(document.getElementById(`score_${atelierIndex}`).value);
            if (!score || score < 0) { alert('Entrez un score valide'); return; }
        }

        wodConfig.ateliers[atelierIndex].records.push({ name, score, category, isDNF: isDNF || false });

        // Sort: AMRAP = desc (more = better), For Time = asc (less = better), DNF at end
        sortRecords(atelierIndex);
        saveSessionData();

        document.getElementById(`name_${atelierIndex}`).value = '';
        document.getElementById(`score_${atelierIndex}`).value = '';
        if (isForTime) {
            const dnfCb = document.getElementById(`dnf_${atelierIndex}`);
            if (dnfCb) dnfCb.checked = false;
        }

        updateRecordsList(atelierIndex);
        updateGlobalRankings();
    }

    function sortRecords(atelierIndex) {
        const recs = wodConfig.ateliers[atelierIndex].records;
        const isForTime = wodConfig.mode === 'fortime';
        recs.sort((a, b) => {
            if (a.isDNF && !b.isDNF) return 1;
            if (!a.isDNF && b.isDNF) return -1;
            if (a.isDNF && b.isDNF) return 0;
            return isForTime ? a.score - b.score : b.score - a.score;
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RECORDS ‚Äî DISPLAY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateRecordsList(atelierIndex) {
        const list = document.getElementById(`records_${atelierIndex}`);
        const records = wodConfig.ateliers[atelierIndex].records.slice(0, 3);
        const isForTime = wodConfig.mode === 'fortime';

        if (records.length === 0) {
            list.innerHTML = '<div class="no-records">Aucun r√©sultat pour le moment</div>';
            return;
        }

        const rankClass = ['first', 'second', 'third'];
        const ranks = ['1er', '2√®me', '3√®me'];
        const catLabels = { boys: 'Gar√ßons', girls: 'Filles', mixed: 'Mixte' };
        const scoreClass = isForTime ? 'record-score fortime-score' : 'record-score';

        list.innerHTML = records.map((r, i) => {
            const scoreText = r.isDNF
                ? '<span class="dnf-badge">DNF</span>'
                : isForTime
                    ? `<span class="${scoreClass}">${formatTime(r.score)}</span>`
                    : `<span class="${scoreClass}">${r.score} reps</span>`;

            return `
                <div class="record-item ${rankClass[i]}">
                    <div class="record-info">
                        <span style="font-size:1.1em;font-weight:bold;">${ranks[i]}</span>
                        <div>
                            <div class="record-name">${r.name}</div>
                            <span class="record-category category-${r.category}">${catLabels[r.category]}</span>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        ${scoreText}
                        <div class="record-actions">
                            <button class="btn-edit-record" onclick="editRecord(${atelierIndex}, ${i})" title="Modifier">‚úèÔ∏è</button>
                            <button class="btn-delete-record" onclick="deleteRecord(${atelierIndex}, ${i})" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editRecord(atelierIndex, recordIndex) {
        const record = wodConfig.ateliers[atelierIndex].records[recordIndex];
        const isForTime = wodConfig.mode === 'fortime';

        document.getElementById(`name_${atelierIndex}`).value = record.name;
        if (isForTime) {
            if (!record.isDNF) document.getElementById(`score_${atelierIndex}`).value = formatTime(record.score);
            const dnfCb = document.getElementById(`dnf_${atelierIndex}`);
            if (dnfCb) dnfCb.checked = !!record.isDNF;
        } else {
            document.getElementById(`score_${atelierIndex}`).value = record.score;
        }

        selectCategory(atelierIndex, record.category);
        wodConfig.ateliers[atelierIndex].records.splice(recordIndex, 1);
        saveSessionData();
        updateRecordsList(atelierIndex);
        updateGlobalRankings();

        const card = document.getElementById(`records_${atelierIndex}`).closest('.atelier-card');
        card.querySelector('.record-input-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function deleteRecord(atelierIndex, recordIndex) {
        const record = wodConfig.ateliers[atelierIndex].records[recordIndex];
        const label = record.isDNF
            ? `${record.name} (DNF)`
            : wodConfig.mode === 'fortime'
                ? `${record.name} (${formatTime(record.score)})`
                : `${record.name} (${record.score} reps)`;

        if (confirm(`Supprimer le r√©sultat de "${label}" ?`)) {
            wodConfig.ateliers[atelierIndex].records.splice(recordIndex, 1);
            saveSessionData();
            updateRecordsList(atelierIndex);
            updateGlobalRankings();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  GLOBAL RANKINGS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateGlobalRankings() {
        const isForTime = wodConfig.mode === 'fortime';
        const allGroups = {};

        wodConfig.ateliers.forEach(atelier => {
            atelier.records.forEach(record => {
                if (!allGroups[record.name]) {
                    allGroups[record.name] = {
                        name: record.name,
                        category: record.category,
                        totalScore: isForTime ? 0 : 0,
                        atelierCount: 0,
                        hasDNF: false
                    };
                }
                if (record.isDNF) {
                    allGroups[record.name].hasDNF = true;
                } else {
                    allGroups[record.name].totalScore += record.score;
                }
                allGroups[record.name].atelierCount++;
            });
        });

        let rankings = Object.values(allGroups)
            .filter(g => g.atelierCount === wodConfig.numAteliers);

        if (isForTime) {
            rankings.sort((a, b) => {
                if (a.hasDNF && !b.hasDNF) return 1;
                if (!a.hasDNF && b.hasDNF) return -1;
                return a.totalScore - b.totalScore; // lower time = better
            });
        } else {
            rankings.sort((a, b) => b.totalScore - a.totalScore);
        }

        rankings = rankings.slice(0, 3);

        if (rankings.length > 0) {
            document.getElementById('globalRankings').style.display = 'block';
            document.getElementById('globalRankTitle').textContent =
                isForTime ? 'Top 3 ‚Äî Meilleurs temps cumul√©s' : 'Top 3 ‚Äî Meilleurs scores cumul√©s';
            displayGlobalTop3(rankings);
        } else {
            document.getElementById('globalRankings').style.display = 'none';
        }
    }

    function displayGlobalTop3(rankings) {
        const container = document.getElementById('globalTop3');
        const isForTime = wodConfig.mode === 'fortime';

        if (rankings.length === 0) {
            container.innerHTML = '<div class="no-records">Aucune √©quipe n\'a termin√© tous les ateliers</div>';
            return;
        }

        const rankClass = ['first', 'second', 'third'];
        const ranks = ['1er', '2√®me', '3√®me'];
        const catLabels = { boys: 'Gar√ßons', girls: 'Filles', mixed: 'Mixte' };

        container.innerHTML = rankings.map((r, i) => {
            const scoreText = r.hasDNF
                ? '<span class="dnf-badge">DNF</span>'
                : isForTime
                    ? `<span class="record-score fortime-score">${formatTime(r.totalScore)}</span>`
                    : `<span class="record-score">${r.totalScore} reps</span>`;

            return `
                <div class="ranking-item ${rankClass[i]}">
                    <div class="record-info">
                        <span style="font-size:1.1em;font-weight:bold;">${ranks[i]}</span>
                        <div>
                            <div class="record-name">${r.name}</div>
                            <span class="record-category category-${r.category}">${catLabels[r.category]}</span>
                        </div>
                    </div>
                    ${scoreText}
                </div>
            `;
        }).join('');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  EMOM ENGINE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let emomSequence = [];     // flat list: [{atelierIdx, exIdx, name, reps}, ...]
    let emomCurrentStep = 0;   // index in full sequence (0-based)
    let emomSecondsLeft = 60;  // seconds remaining in current minute
    let emomInterval = null;
    let emomIsRunning = false;
    let emomTotalMinutes = 0;

    function buildEmomSequence() {
        emomSequence = [];
        const tours = wodConfig.numTours || 3;
        for (let t = 0; t < tours; t++) {
            wodConfig.ateliers.forEach((atelier, ai) => {
                atelier.exercises.forEach((ex, ei) => {
                    emomSequence.push({
                        atelierIdx: ai,
                        exIdx: ei,
                        name: ex.name,
                        reps: ex.reps,
                        tour: t + 1,
                        minuteNum: emomSequence.length + 1
                    });
                });
            });
        }
        emomTotalMinutes = emomSequence.length;
    }

    function renderEmomAtelierCards() {
        // Show ateliers as read-only reference cards with orange theme
        const grid = document.getElementById('ateliersGrid');
        grid.innerHTML = '';
        grid.className = `main-grid cols-${wodConfig.numAteliers}`;

        wodConfig.ateliers.forEach((atelier, index) => {
            const card = document.createElement('div');
            card.className = 'atelier-card';
            card.id = `emomAtelierCard_${index}`;

            const exercisesHTML = atelier.exercises.map((ex, i) => `
                <div class="exercise" style="border-color:#ed8936;">
                    <div class="exercise-reps" style="color:#ed8936;">${ex.reps}</div>
                    <div class="exercise-name">${ex.name}</div>
                </div>
                ${i < atelier.exercises.length - 1 ? '<div class="plus-sign" style="color:#ed8936;">+</div>' : ''}
            `).join('');

            card.innerHTML = `
                <div class="atelier-header" style="background:linear-gradient(135deg,#c05621,#9c4221);">
                    <h3>Atelier ${index + 1}</h3>
                    <div class="atelier-duration">${atelier.exercises.length} exercice${atelier.exercises.length>1?'s':''}</div>
                </div>
                <div class="exercises">${exercisesHTML}</div>
            `;
            grid.appendChild(card);
        });
    }

    function initEmomDisplay() {
        buildEmomSequence();
        emomCurrentStep = 0;
        emomSecondsLeft = 60;
        emomIsRunning = false;

        // Build rounds dots
        const tours = wodConfig.numTours || 3;
        const roundsRow = document.getElementById('emomRoundsRow');
        roundsRow.innerHTML = '';
        for (let t = 1; t <= tours; t++) {
            const dot = document.createElement('div');
            dot.className = 'emom-round-dot';
            dot.id = `emomRoundDot_${t}`;
            dot.textContent = t;
            roundsRow.appendChild(dot);
        }
        if (roundsRow.children[0]) roundsRow.children[0].className = 'emom-round-dot active';

        updateEmomDisplay();
        renderEmomSequenceList();
    }

    function updateEmomDisplay() {
        if (emomCurrentStep >= emomTotalMinutes) {
            // Finished
            stopEmom(true);
            return;
        }

        const step = emomSequence[emomCurrentStep];
        const nextStep = emomSequence[emomCurrentStep + 1] || null;

        // Minute number
        document.getElementById('emomMinuteNum').textContent = step.minuteNum;

        // Tour number
        document.getElementById('emomTourNum').textContent = step.tour;

        // Countdown
        const cd = document.getElementById('emomCountdown');
        cd.textContent = emomSecondsLeft;
        cd.className = 'emom-minute-countdown' + (emomSecondsLeft <= 10 ? ' warning-emom' : '');

        // Progress bar
        const pct = (emomSecondsLeft / 60) * 100;
        document.getElementById('emomProgressBar').style.width = pct + '%';

        // Current exercise card
        document.getElementById('emomCurrentName').textContent = step.name;
        document.getElementById('emomCurrentReps').textContent = step.reps;

        // Next exercise
        if (nextStep) {
            document.getElementById('emomNextName').textContent = nextStep.name;
            document.getElementById('emomNextReps').textContent = `${nextStep.reps} reps ‚Äî Tour ${nextStep.tour}`;
            document.getElementById('emomNextCard').style.display = 'flex';
        } else {
            document.getElementById('emomNextName').textContent = 'üèÅ Dernier exercice !';
            document.getElementById('emomNextReps').textContent = '';
            document.getElementById('emomNextCard').style.display = 'flex';
        }

        // Rounds dots
        for (let t = 1; t <= (wodConfig.numTours || 3); t++) {
            const dot = document.getElementById(`emomRoundDot_${t}`);
            if (!dot) continue;
            if (t < step.tour) dot.className = 'emom-round-dot done';
            else if (t === step.tour) dot.className = 'emom-round-dot active';
            else dot.className = 'emom-round-dot';
        }

        // Highlight atelier card
        wodConfig.ateliers.forEach((_, ai) => {
            const c = document.getElementById(`emomAtelierCard_${ai}`);
            if (c) c.style.outline = ai === step.atelierIdx ? '3px solid #ed8936' : 'none';
        });

        renderEmomSequenceList();
    }

    function renderEmomSequenceList() {
        const container = document.getElementById('emomSequenceList');
        container.innerHTML = emomSequence.map((s, i) => {
            let cls = 'seq-future', icon = '‚óã';
            if (i < emomCurrentStep) { cls = 'seq-done'; icon = '‚úì'; }
            else if (i === emomCurrentStep) { cls = 'seq-active'; icon = '‚ñ∂'; }
            return `
                <div class="emom-seq-item ${cls}" id="emomSeqItem_${i}">
                    <span class="emom-seq-min">Min ${s.minuteNum}</span>
                    <span class="emom-seq-icon">${icon}</span>
                    <span style="flex:1">${s.name}</span>
                    <span style="font-weight:bold;">${s.reps} reps</span>
                    <span style="color:#718096;font-size:0.8em;margin-left:6px;">Tour ${s.tour}</span>
                </div>
            `;
        }).join('');

        // Scroll active item into view
        const activeItem = document.getElementById(`emomSeqItem_${emomCurrentStep}`);
        if (activeItem) activeItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }

    function startEmom() {
        if (emomIsRunning) return;
        if (emomCurrentStep >= emomTotalMinutes) return;
        emomIsRunning = true;
        emomInterval = setInterval(tickEmom, 1000);
    }

    function pauseEmom() {
        emomIsRunning = false;
        clearInterval(emomInterval);
    }

    function resetEmom() {
        pauseEmom();
        emomCurrentStep = 0;
        emomSecondsLeft = 60;
        document.getElementById('emomFinished').style.display = 'none';
        document.getElementById('emomPanel').style.display = 'block';
        initEmomDisplay();
    }

    function tickEmom() {
        emomSecondsLeft--;

        if (emomSecondsLeft <= 0) {
            // Beep at end of minute
            playBeep();
            emomCurrentStep++;
            emomSecondsLeft = 60;

            if (emomCurrentStep >= emomTotalMinutes) {
                stopEmom(true);
                return;
            }
            // Animate new card
            const card = document.getElementById('emomCurrentCard');
            card.classList.remove('fadeInSlide');
            void card.offsetWidth;
            card.classList.add('fadeInSlide');
        }

        updateEmomDisplay();
    }

    function stopEmom(finished) {
        pauseEmom();
        if (finished) {
            const tours = wodConfig.numTours || 3;
            const totalEx = emomTotalMinutes;
            document.getElementById('emomPanel').style.display = 'none';
            document.getElementById('emomFinished').style.display = 'block';
            document.getElementById('emomFinishedMsg').textContent =
                `${tours} tour${tours>1?'s':''} √ó ${totalEx / tours} exercice${totalEx/tours>1?'s':''} = ${totalEx} minutes r√©alis√©es ! Bravo √† tous ! üí™`;
            // All round dots done
            for (let t = 1; t <= tours; t++) {
                const dot = document.getElementById(`emomRoundDot_${t}`);
                if (dot) dot.className = 'emom-round-dot done';
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TIMER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function startTimer() {
        if (wodConfig.mode === 'emom') { startEmom(); return; }
        if (isRunning) return;
        isRunning = true;
        const isForTime = wodConfig.mode === 'fortime';
        if (isForTime) {
            document.getElementById('timerDisplay').classList.add('fortime-running');
            timerInterval = setInterval(() => {
                timeElapsed++;
                const m = Math.floor(timeElapsed / 60);
                const s = timeElapsed % 60;
                document.getElementById('timerDisplay').textContent =
                    `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                const cap = wodConfig.duration * 60;
                const remaining = cap - timeElapsed;
                if (remaining <= 10 && remaining > 0) {
                    document.getElementById('timerDisplay').classList.add('warning');
                    document.getElementById('timerDisplay').classList.remove('fortime-running');
                }
                if (timeElapsed >= cap) {
                    pauseTimer();
                    document.getElementById('timerDisplay').classList.remove('warning');
                    playBeep();
                    setTimeout(() => alert('TIME CAP ATTEINT ! STOP !'), 1200);
                }
            }, 1000);
        } else {
            if (timeLeft === 0) timeLeft = wodConfig.duration * 60;
            timerInterval = setInterval(updateTimerAMRAP, 1000);
        }
    }

    function updateTimerAMRAP() {
        if (timeLeft > 0) {
            timeLeft--;
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('timerDisplay').textContent =
                `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if (timeLeft <= 10 && timeLeft > 0) document.getElementById('timerDisplay').classList.add('warning');
            if (timeLeft === 0) {
                pauseTimer();
                document.getElementById('timerDisplay').classList.remove('warning');
                playBeep();
                setTimeout(() => alert('TEMPS √âCOUL√â ! STOP !'), 1200);
            }
        }
    }

    function pauseTimer() {
        if (wodConfig.mode === 'emom') { pauseEmom(); return; }
        isRunning = false;
        clearInterval(timerInterval);
    }

    function resetTimer() {
        if (wodConfig.mode === 'emom') { resetEmom(); return; }
        isRunning = false;
        clearInterval(timerInterval);
        const isForTime = wodConfig.mode === 'fortime';
        const display = document.getElementById('timerDisplay');
        if (isForTime) {
            timeElapsed = 0;
            display.textContent = '00:00';
            display.classList.remove('warning', 'fortime-running');
        } else {
            timeLeft = wodConfig.duration * 60;
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            display.classList.remove('warning', 'fortime-running');
        }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  APP NAVIGATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function resetApp() {
        if (confirm('Recommencer la configuration ?\n\nLes records seront conserv√©s en localStorage.')) location.reload();
    }

    function createNewWOD() {
        currentWODId = null;
        wodConfig = { name:'', mode:'amrap', teamSize:1, numAteliers:3, duration:5, numTours:3, ateliers:[] };
        selectedWodMode = 'amrap';
        selectedTeamSize = 1;
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('setupOverlay').style.display = 'flex';
        selectWodMode('amrap');
    }

    function backToWelcome() {
        document.getElementById('myWODsScreen').style.display = 'none';
        document.getElementById('welcomeScreen').style.display = 'flex';
    }

    async function showMyWODs() {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('myWODsScreen').style.display = 'flex';
        await loadSavedWODs();
    }

    async function loadSavedWODs() {
        try {
            const snapshot = await database.ref('wods').once('value');
            const container = document.getElementById('wodsList');
            if (!snapshot.exists()) {
                container.innerHTML = '<div class="no-records" style="padding:20px;">Aucun WOD sauvegard√© pour le moment</div>';
                return;
            }
            savedWODs = snapshot.val();
            const wodArray = Object.entries(savedWODs).map(([id, data]) => ({ id, ...data }));
            wodArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            container.innerHTML = wodArray.map(wod => {
                const mode = wod.mode || 'amrap';
                const teamLabelsMap = { 1:'üßç Indiv', 2:'üë• Duo', 3:'üë• Trio', 4:'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 4 √©l√®ves', 5:'üèÖ 5 √©l√®ves' };
                const modeLabelMap = { amrap:'AMRAP', fortime:'For Time', emom:'EMOM' };
                const modeLabel = modeLabelMap[mode] || 'AMRAP';
                const preview = wod.ateliers.map((a, i) =>
                    `Atelier ${i+1}: ${a.exercises.map(e => `${e.reps} ${e.name}`).join(' + ')}`
                ).join(' | ');

                return `
                    <div class="wod-card">
                        <div class="wod-card-header">
                            <div class="wod-card-title">${wod.name}</div>
                            <span class="wod-mode-pill ${mode}">${modeLabel}</span>
                            <span class="team-badge" style="font-size:0.7em;">${teamLabelsMap[wod.teamSize||1]||'üßç Indiv'}</span>
                        </div>
                        <div class="wod-card-info">
                            ${wod.numAteliers} atelier${wod.numAteliers > 1 ? 's' : ''}
                            ${mode === 'emom' ? `√ó ${wod.numTours || 3} tours` : `√ó ${wod.duration} min`}
                        </div>
                        <div class="wod-card-preview">${preview.substring(0, 150)}${preview.length > 150 ? '...' : ''}</div>
                        <div class="wod-card-actions">
                            <button class="btn-wod btn-load" onclick="loadWOD('${wod.id}')">Charger</button>
                            <button class="btn-wod btn-modify" onclick="modifyWOD('${wod.id}')">Modifier</button>
                            <button class="btn-wod btn-duplicate" onclick="duplicateWOD('${wod.id}')">Dupliquer</button>
                            <button class="btn-wod btn-delete-wod" onclick="deleteWOD('${wod.id}')">Supprimer</button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch(e) {
            console.error('Erreur chargement WODs:', e);
            alert('Erreur lors du chargement des WODs');
        }
    }

    async function loadWOD(id) {
        const wod = savedWODs[id];
        if (!wod) return;
        currentWODId = id;
        wodConfig = { ...wod, mode: wod.mode || 'amrap', teamSize: wod.teamSize || 1, numTours: wod.numTours || 3 };
        document.getElementById('myWODsScreen').style.display = 'none';
        finishSetup();
    }

    async function modifyWOD(id) {
        const wod = savedWODs[id];
        if (!wod) return;
        currentWODId = id;
        wodConfig = { ...wod, mode: wod.mode || 'amrap' };
        selectedWodMode = wodConfig.mode;
        selectedTeamSize = wodConfig.teamSize || 1;

        // Restore EMOM tours in form if applicable
        if (wodConfig.mode === 'emom') {
            const nt = document.getElementById('numTours');
            if (nt) nt.value = wodConfig.numTours || 3;
        }

        document.getElementById('myWODsScreen').style.display = 'none';
        document.getElementById('setupOverlay').style.display = 'flex';
        document.getElementById('wodName').value = wod.name;
        document.getElementById('numAteliers').value = wod.numAteliers;
        document.getElementById('duration').value = wod.duration;
        selectWodMode(wodConfig.mode);
        selectTeamSize(selectedTeamSize);
    }

    async function duplicateWOD(id) {
        const wod = savedWODs[id];
        if (!wod) return;
        const newName = prompt('Nom du WOD dupliqu√©:', wod.name + ' (copie)');
        if (!newName) return;
        try {
            await database.ref('wods').push({ ...wod, name: newName, createdAt: new Date().toISOString() });
            alert('WOD dupliqu√© !');
            await loadSavedWODs();
        } catch(e) { alert('Erreur lors de la duplication'); }
    }

    async function deleteWOD(id) {
        const wod = savedWODs[id];
        if (!wod) return;
        if (!confirm(`Supprimer le WOD "${wod.name}" ?\n\nCette action est irr√©versible.`)) return;
        try {
            await database.ref('wods/' + id).remove();
            alert('WOD supprim√© !');
            await loadSavedWODs();
        } catch(e) { alert('Erreur lors de la suppression'); }
    }

    async function saveWODToFirebase() {
        try {
            if (!wodConfig.name) { alert('Le WOD doit avoir un nom'); return false; }
            const wodData = {
                name: wodConfig.name,
                mode: wodConfig.mode || 'amrap',
                teamSize: wodConfig.teamSize || 1,
                numTours: wodConfig.numTours || 3,
                numAteliers: wodConfig.numAteliers,
                duration: wodConfig.duration,
                ateliers: wodConfig.ateliers.map(a => ({ exercises: a.exercises })),
                createdAt: currentWODId && savedWODs[currentWODId]
                    ? savedWODs[currentWODId].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            if (currentWODId) {
                await database.ref('wods/' + currentWODId).set(wodData);
            } else {
                const ref = await database.ref('wods').push(wodData);
                currentWODId = ref.key;
            }
            return true;
        } catch(e) {
            console.error('Erreur sauvegarde:', e);
            alert('Erreur lors de la sauvegarde: ' + e.message);
            return false;
        }
    }

    function backToConfig() {
        document.getElementById('saveLaunchScreen').style.display = 'none';
        currentAtelierIndex = Math.max(0, wodConfig.ateliers.length - 1);
        document.getElementById('atelierSetupOverlay').style.display = 'flex';
        showAtelierConfig();
    }

    async function launchNow() {
        document.getElementById('saveLaunchScreen').style.display = 'none';
        showMainContainer();
    }

    async function saveForLater() {
        const saved = await saveWODToFirebase();
        if (saved) { alert(`WOD "${wodConfig.name}" sauvegard√© !`); location.reload(); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SETTINGS / EXERCISES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openSettings() {
        document.getElementById('settingsOverlay').style.display = 'flex';
        renderExerciseList();
    }

    function openSettingsFromWelcome() {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('settingsOverlay').style.display = 'flex';
        renderExerciseList();
    }

    function closeSettings() {
        document.getElementById('settingsOverlay').style.display = 'none';
        cancelEditExercise();
        if (!document.getElementById('mainContainer').classList.contains('visible')) {
            document.getElementById('welcomeScreen').style.display = 'flex';
        }
    }

    async function loadExercisesFromFirebase() {
        try {
            const snapshot = await database.ref('exercises').once('value');
            if (snapshot.exists()) {
                const fb = snapshot.val();
                exerciseData = { ...exerciseData, ...fb };
                Object.keys(fb).forEach(name => {
                    if (!EXERCISES.includes(name)) EXERCISES.push(name);
                });
                EXERCISES.sort();
            }
        } catch(e) { console.error('Erreur chargement exercices:', e); }
    }

    async function saveExerciseToFirebase(name, data) {
        try {
            await database.ref('exercises/' + name).set(data);
            return true;
        } catch(e) {
            alert('Erreur lors de la sauvegarde sur Firebase');
            return false;
        }
    }

    async function deleteExerciseFromFirebase(name) {
        try {
            await database.ref('exercises/' + name).remove();
            return true;
        } catch(e) { return false; }
    }

    function renderExerciseList() {
        const container = document.getElementById('exerciseListContainer');
        container.innerHTML = EXERCISES.sort().map(name => {
            const data = exerciseData[name] || { description: '', images: [] };
            const hasData = data.description || data.images.length > 0;
            const preview = data.description
                ? data.description.substring(0, 50) + (data.description.length > 50 ? '...' : '')
                : 'Aucune description';
            return `
                <div class="exercise-list-item" style="${!hasData ? 'opacity:0.7;' : ''}">
                    <div class="exercise-info">
                        <div class="exercise-title">${name}${!hasData ? ' <span style="font-size:0.8em;opacity:0.6;">(non document√©)</span>' : ''}</div>
                        <div class="exercise-desc-preview">${preview}</div>
                    </div>
                    <div class="exercise-actions">
                        <button class="btn-edit" onclick="editExercise('${name}')">${hasData ? 'Modifier' : 'Documenter'}</button>
                        ${hasData ? `<button class="btn-delete" onclick="deleteExerciseData('${name}')">Supprimer donn√©es</button>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function previewImage(index) {
        const input = document.getElementById(`imageInput${index + 1}`);
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => { imagePreviews[index] = e.target.result; updateImagePreview(); };
            reader.readAsDataURL(file);
        }
    }

    function updateImagePreview() {
        const container = document.getElementById('imagePreviewContainer');
        container.innerHTML = imagePreviews.map((img, i) => {
            if (!img) return '';
            return `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview ${i+1}">
                    <button class="remove-image" onclick="removeImage(${i})">√ó</button>
                </div>
            `;
        }).filter(Boolean).join('');
    }

    function removeImage(index) {
        imagePreviews[index] = null;
        document.getElementById(`imageInput${index + 1}`).value = '';
        updateImagePreview();
    }

    async function saveExercise() {
        const name = document.getElementById('exerciseName').value.trim();
        const description = document.getElementById('exerciseDescription').value.trim();
        if (!name) { alert('Entrez un nom d\'exercice'); return; }

        const isNew = !EXERCISES.includes(name);
        const info = { description, images: imagePreviews.filter(Boolean) };
        const saved = await saveExerciseToFirebase(name, info);
        if (!saved) return;

        exerciseData[name] = info;
        if (isNew) { EXERCISES.push(name); EXERCISES.sort(); }

        document.getElementById('exerciseName').value = '';
        document.getElementById('exerciseName').disabled = false;
        document.getElementById('exerciseDescription').value = '';
        document.getElementById('imageInput1').value = '';
        document.getElementById('imageInput2').value = '';
        imagePreviews = [null, null];
        updateImagePreview();
        renderExerciseList();
        currentEditingExercise = null;
        document.getElementById('formTitle').textContent = 'Ajouter un nouvel exercice';
        document.getElementById('saveButtonText').textContent = 'Cr√©er l\'exercice';
        document.getElementById('cancelEditBtn').style.display = 'none';

        alert(isNew ? `Exercice "${name}" cr√©√© !` : `Documentation de "${name}" mise √† jour !`);
    }

    function editExercise(name) {
        currentEditingExercise = name;
        const data = exerciseData[name] || { description: '', images: [] };
        document.getElementById('exerciseName').value = name;
        document.getElementById('exerciseName').disabled = true;
        document.getElementById('exerciseDescription').value = data.description || '';
        imagePreviews = data.images ? [...data.images] : [];
        while (imagePreviews.length < 2) imagePreviews.push(null);
        updateImagePreview();
        const hasData = data.description || data.images.length > 0;
        document.getElementById('formTitle').textContent = hasData ? 'Modifier l\'exercice' : 'Documenter l\'exercice';
        document.getElementById('saveButtonText').textContent = 'Enregistrer';
        document.getElementById('cancelEditBtn').style.display = 'block';
        document.querySelector('.add-exercise-form').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEditExercise() {
        currentEditingExercise = null;
        document.getElementById('exerciseName').value = '';
        document.getElementById('exerciseName').disabled = false;
        document.getElementById('exerciseDescription').value = '';
        document.getElementById('imageInput1').value = '';
        document.getElementById('imageInput2').value = '';
        imagePreviews = [null, null];
        updateImagePreview();
        document.getElementById('formTitle').textContent = 'Ajouter un nouvel exercice';
        document.getElementById('saveButtonText').textContent = 'Cr√©er l\'exercice';
        document.getElementById('cancelEditBtn').style.display = 'none';
    }

    async function deleteExerciseData(name) {
        if (!confirm(`Supprimer la description et les images de "${name}" ?`)) return;
        const deleted = await deleteExerciseFromFirebase(name);
        if (!deleted) return;
        delete exerciseData[name];
        renderExerciseList();
        alert(`Documentation de "${name}" supprim√©e !`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.onload = async function() {
        // Hide welcome screen until auth check completes
        document.getElementById('welcomeScreen').style.display = 'none';
        generateExerciseInputs(2);
        await loadExercisesFromFirebase();
    };
    </script>
</body>
</html>
